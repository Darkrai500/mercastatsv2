# ETAPA 1: Compilación
# Usamos Rust 1.83 para evitar errores de dependencias modernas como icu_normalizer_data
FROM rust:1.83-slim-bookworm AS builder

# 1. Instalamos dependencias del sistema necesarias para Trunk y SSL
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# 2. Instalamos la última versión de Trunk y el soporte para WebAssembly
RUN cargo install --locked trunk
RUN rustup target add wasm32-unknown-unknown

WORKDIR /app

# 3. Copiamos los archivos de configuración
# El asterisco en Cargo.lock* permite que el build siga aunque no lo tengas localmente
COPY Cargo.toml Cargo.lock* Trunk.toml index.html ./

# 4. Copiamos el código fuente y la carpeta public (donde está el favicon)
# Esto soluciona el error "No such file or directory (os error 2)"
COPY src ./src
COPY public ./public

# 5. Compilamos el proyecto para producción
# Genera los archivos optimizados en la carpeta /dist
RUN trunk build --release

# ETAPA 2: Servidor Web ligero
FROM nginx:alpine

# 6. Copiamos la configuración de Nginx para manejar rutas de SPA (Leptos)
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 7. Copiamos los archivos compilados desde la etapa anterior
COPY --from=builder /app/dist /usr/share/nginx/html

# 8. Exponemos el puerto estándar para tráfico HTTP
EXPOSE 80